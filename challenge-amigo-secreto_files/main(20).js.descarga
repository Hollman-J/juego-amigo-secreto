define(function(require,exports,module){var AppInit=brackets.getModule("utils/AppInit"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),Strings=brackets.getModule("strings"),RenameIdentifier=require("RenameIdentifier"),ExtractToVariable=require("ExtractToVariable"),ExtractToFunction=require("ExtractToFunction"),WrapSelection=require("WrapSelection"),CommandManager=brackets.getModule("command/CommandManager"),Menus=brackets.getModule("command/Menus"),Metrics=brackets.getModule("utils/Metrics"),_=brackets.getModule("thirdparty/lodash"),EditorManager=brackets.getModule("editor/EditorManager");require("HighLightReferences");var jsRefactoringEnabled=!0,KeyboardPrefs=JSON.parse(require("text!keyboard.json")),EXTRACTTO_VARIABLE="refactoring.extractToVariable",EXTRACTTO_FUNCTION="refactoring.extractToFunction",REFACTOR_RENAME="refactoring.renamereference",REFACTORWRAPINTRYCATCH="refactoring.wrapintrycatch",REFACTORWRAPINCONDITION="refactoring.wrapincondition",REFACTORCONVERTTOARROWFN="refactoring.converttoarrowfunction",REFACTORCREATEGETSET="refactoring.creategettersandsetters";function _isRefactoringEnabled(){return!1!==PreferencesManager.get("refactoring.JSRefactoring")}function _handleRefactor(functionName){var eventName,eventType="";switch(functionName){case REFACTOR_RENAME:eventName=REFACTOR_RENAME,eventType="rename",RenameIdentifier.handleRename();break;case EXTRACTTO_VARIABLE:eventName=EXTRACTTO_VARIABLE,eventType="extractToVariable",ExtractToVariable.handleExtractToVariable();break;case EXTRACTTO_FUNCTION:eventName=EXTRACTTO_FUNCTION,eventType="extractToFunction",ExtractToFunction.handleExtractToFunction();break;case REFACTORWRAPINTRYCATCH:eventName=REFACTORWRAPINTRYCATCH,eventType="wrapInTryCatch",WrapSelection.wrapInTryCatch();break;case REFACTORWRAPINCONDITION:eventName=REFACTORWRAPINCONDITION,eventType="wrapInCondition",WrapSelection.wrapInCondition();break;case REFACTORCONVERTTOARROWFN:eventName=REFACTORCONVERTTOARROWFN,eventType="convertToFunction",WrapSelection.convertToArrowFunction();break;case REFACTORCREATEGETSET:eventName=REFACTORCREATEGETSET,eventType="createGetterSetter",WrapSelection.createGettersAndSetters()}if(eventName){var editor=EditorManager.getActiveEditor();if(!editor||"javascript"!==editor.getModeForSelection())return;Metrics.countEvent(Metrics.EVENT_TYPE.CODE_HINTS,"jsRefactor",eventType)}}PreferencesManager.definePreference("refactoring.JSRefactoring","boolean",!0,{description:Strings.DESCRIPTION_CODE_REFACTORING}),PreferencesManager.on("change","refactoring.JSRefactoring",function(){jsRefactoringEnabled=_isRefactoringEnabled()}),AppInit.appReady(function(){if(jsRefactoringEnabled){var subMenu=Menus.getContextMenu(Menus.ContextMenuIds.EDITOR_MENU).addSubMenu(Strings.CMD_REFACTOR,"refactor-submenu"),menuLocation=Menus.AppMenuBar.EDIT_MENU;Menus.getMenu(menuLocation).addMenuDivider(),CommandManager.register(Strings.CMD_REFACTORING_RENAME,REFACTOR_RENAME,_.partial(_handleRefactor,REFACTOR_RENAME)),subMenu.addMenuItem(REFACTOR_RENAME),Menus.getMenu(menuLocation).addMenuItem(REFACTOR_RENAME,KeyboardPrefs.renameIdentifier),CommandManager.register(Strings.CMD_EXTRACTTO_VARIABLE,EXTRACTTO_VARIABLE,_.partial(_handleRefactor,EXTRACTTO_VARIABLE)),subMenu.addMenuItem(EXTRACTTO_VARIABLE),Menus.getMenu(menuLocation).addMenuItem(EXTRACTTO_VARIABLE,KeyboardPrefs.extractToVariable),CommandManager.register(Strings.CMD_EXTRACTTO_FUNCTION,EXTRACTTO_FUNCTION,_.partial(_handleRefactor,EXTRACTTO_FUNCTION)),subMenu.addMenuItem(EXTRACTTO_FUNCTION),Menus.getMenu(menuLocation).addMenuItem(EXTRACTTO_FUNCTION,KeyboardPrefs.extractToFunction),CommandManager.register(Strings.CMD_REFACTORING_TRY_CATCH,REFACTORWRAPINTRYCATCH,_.partial(_handleRefactor,REFACTORWRAPINTRYCATCH)),subMenu.addMenuItem(REFACTORWRAPINTRYCATCH),Menus.getMenu(menuLocation).addMenuItem(REFACTORWRAPINTRYCATCH),CommandManager.register(Strings.CMD_REFACTORING_CONDITION,REFACTORWRAPINCONDITION,_.partial(_handleRefactor,REFACTORWRAPINCONDITION)),subMenu.addMenuItem(REFACTORWRAPINCONDITION),Menus.getMenu(menuLocation).addMenuItem(REFACTORWRAPINCONDITION),CommandManager.register(Strings.CMD_REFACTORING_ARROW_FUNCTION,REFACTORCONVERTTOARROWFN,_.partial(_handleRefactor,REFACTORCONVERTTOARROWFN)),subMenu.addMenuItem(REFACTORCONVERTTOARROWFN),Menus.getMenu(menuLocation).addMenuItem(REFACTORCONVERTTOARROWFN),CommandManager.register(Strings.CMD_REFACTORING_GETTERS_SETTERS,REFACTORCREATEGETSET,_.partial(_handleRefactor,REFACTORCREATEGETSET)),subMenu.addMenuItem(REFACTORCREATEGETSET),Menus.getMenu(menuLocation).addMenuItem(REFACTORCREATEGETSET)}})}),define("ExtractToFunction",function(require,exports,module){var ASTWalker=brackets.getModule("thirdparty/acorn/dist/walk"),EditorManager=brackets.getModule("editor/EditorManager"),_=brackets.getModule("thirdparty/lodash"),StringUtils=brackets.getModule("utils/StringUtils"),Session=brackets.getModule("JSUtils/Session"),RefactoringUtils=require("RefactoringUtils"),Strings=brackets.getModule("strings"),InlineMenu=brackets.getModule("widgets/InlineMenu").InlineMenu,template=JSON.parse(require("text!Templates.json")),session=null;function analyzeCode(text,scopes,srcScope,destScope,start,end){var identifiers={},inThisScope={},thisPointerUsed=!1,returnStatementUsed=!1,variableDeclarations={},changedValues={},dependentValues={},ast=RefactoringUtils.getAST(text),doc=session.editor.document,restScopeStr;ASTWalker.full(ast,function(node){var value,name;switch(node.type){case"AssignmentExpression":value=node.left;break;case"VariableDeclarator":inThisScope[node.id.name]=!0,value=node.init&&node.id;var variableDeclarationNode=RefactoringUtils.findSurroundASTNode(ast,node,["VariableDeclaration"]);variableDeclarations[node.id.name]=variableDeclarationNode.kind;break;case"ThisExpression":thisPointerUsed=!0;break;case"UpdateExpression":value=node.argument;break;case"Identifier":identifiers[node.name]=!0;break;case"ReturnStatement":returnStatementUsed=!0}value&&(name="MemberExpression"===value.type?value.object.name:value.name,changedValues[name]=!0)}),restScopeStr=srcScope.originNode?doc.getText().substr(end,srcScope.originNode.end-end):doc.getText().substr(end),ASTWalker.simple(RefactoringUtils.getAST(restScopeStr),{Identifier:function(node){var name=node.name;dependentValues[name]=!0},Expression:function(node){if("MemberExpression"===node.type){var name=node.object.name;dependentValues[name]=!0}}});var passProps=scopes.slice(srcScope.id,destScope.id).reduce(function(props,scope){return _.union(props,_.keys(scope.props))},[]),retProps=scopes.slice(srcScope.id,destScope.id+1).reduce(function(props,scope){return _.union(props,_.keys(scope.props))},[]);return{passParams:_.intersection(_.difference(_.keys(identifiers),_.keys(inThisScope)),passProps),retParams:_.intersection(_.keys(changedValues),_.keys(dependentValues),retProps),thisPointerUsed:thisPointerUsed,returnStatementUsed:returnStatementUsed,variableDeclarations:variableDeclarations}}function extract(ast,text,scopes,srcScope,destScope,start,end,isExpression){var retObj=analyzeCode(text,scopes,srcScope,destScope,start,end),passParams=retObj.passParams,retParams=retObj.retParams,thisPointerUsed=retObj.thisPointerUsed,returnStatementUsed=retObj.returnStatementUsed,variableDeclarations=retObj.variableDeclarations,doc=session.editor.document,fnBody=text,fnName=RefactoringUtils.getUniqueIdentifierName(scopes,"extracted"),fnDeclaration,fnCall;function appendVarDeclaration(identifier){return variableDeclarations.hasOwnProperty(identifier)?variableDeclarations[identifier]+" "+identifier:identifier}if(destScope.isClass?fnCall=StringUtils.format(template.functionCall.class,fnName,passParams.join(", ")):thisPointerUsed?(passParams.unshift("this"),fnCall=StringUtils.format(template.functionCall.thisPointer,fnName,passParams.join(", ")),passParams.shift()):fnCall=StringUtils.format(template.functionCall.normal,fnName,passParams.join(", ")),returnStatementUsed&&(fnCall="return "+fnCall),isExpression)fnBody=StringUtils.format(template.returnStatement.single,fnBody);else{var retParamsStr="";retParams.length>1?(retParamsStr=StringUtils.format(template.returnStatement.multiple,retParams.join(", ")),fnCall="var ret = "+fnCall+";\n",fnCall+=retParams.map(function(param){return StringUtils.format(template.assignment,appendVarDeclaration(param),"ret."+param)}).join("\n")):1===retParams.length?(retParamsStr=StringUtils.format(template.returnStatement.single,retParams.join(", ")),fnCall=StringUtils.format(template.assignment,appendVarDeclaration(retParams[0]),fnCall)):fnCall+=";",fnBody=fnBody+"\n"+retParamsStr}fnDeclaration=destScope.isClass?StringUtils.format(template.functionDeclaration.class,fnName,passParams.join(", "),fnBody):StringUtils.format(template.functionDeclaration.normal,fnName,passParams.join(", "),fnBody),start=session.editor.posFromIndex(start),end=session.editor.posFromIndex(end);for(var insertPos=_.clone(start),fnScopes=scopes.filter(RefactoringUtils.isFnScope),i=0;i<fnScopes.length;++i)if(fnScopes[i].id===destScope.id){if(fnScopes[i-1]&&(insertPos=session.editor.posFromIndex(fnScopes[i-1].originNode.start),"FunctionExpression"===fnScopes[i-1].originNode.type||"ArrowFunctionExpression"===fnScopes[i-1].originNode.type)){var surroundStatement=RefactoringUtils.findSurroundASTNode(ast,{start:session.editor.indexFromPos(insertPos)},["Statement"]);insertPos=session.editor.posFromIndex(surroundStatement.start)}break}insertPos.ch=0,doc.batchOperation(function(){doc.replaceRange(fnCall,start,end),doc.replaceRange(fnDeclaration,insertPos),start=doc.adjustPosForChange(start,fnDeclaration.split("\n"),insertPos,insertPos),end=doc.adjustPosForChange(end,fnDeclaration.split("\n"),insertPos,insertPos),session.editor.setSelections([{start:session.editor.posFromIndex(session.editor.indexFromPos(start)+fnCall.indexOf(fnName)),end:session.editor.posFromIndex(session.editor.indexFromPos(start)+fnCall.indexOf(fnName)+fnName.length)},{start:session.editor.posFromIndex(session.editor.indexFromPos(insertPos)+fnDeclaration.indexOf(fnName)),end:session.editor.posFromIndex(session.editor.indexFromPos(insertPos)+fnDeclaration.indexOf(fnName)+fnName.length)}]);for(var i=start.line;i<start.line+RefactoringUtils.numLines(fnCall);++i)session.editor._codeMirror.indentLine(i,"smart");for(var i=insertPos.line;i<insertPos.line+RefactoringUtils.numLines(fnDeclaration);++i)session.editor._codeMirror.indentLine(i,"smart")})}function handleExtractToFunction(){var editor=EditorManager.getActiveEditor(),result=new $.Deferred;if(editor.getSelections().length>1)return editor.displayErrorMessageAtCursor(Strings.ERROR_EXTRACTTO_FUNCTION_MULTICURSORS),void result.resolve(Strings.ERROR_EXTRACTTO_FUNCTION_MULTICURSORS);initializeSession(editor);var selection=editor.getSelection(),doc=editor.document,retObj=RefactoringUtils.normalizeText(editor.getSelectedText(),editor.indexFromPos(selection.start),editor.indexFromPos(selection.end)),text=retObj.text,start=retObj.start,end=retObj.end,ast,scopes,expns,inlineMenu;return RefactoringUtils.getScopeData(session,editor.posFromIndex(start)).done(function(scope){ast=RefactoringUtils.getAST(doc.getText());var isExpression=!1;return RefactoringUtils.checkStatement(ast,start,end,doc.getText())||(isExpression=RefactoringUtils.getExpression(ast,start,end,doc.getText()))?1===(scopes=RefactoringUtils.getAllScopes(ast,scope,doc.getText())).length?(extract(ast,text,scopes,scopes[0],scopes[0],start,end,isExpression),void result.resolve()):((inlineMenu=new InlineMenu(editor,Strings.EXTRACTTO_FUNCTION_SELECT_SCOPE)).open(scopes.filter(RefactoringUtils.isFnScope)),result.resolve(inlineMenu),inlineMenu.onSelect(function(scopeId){extract(ast,text,scopes,scopes[0],scopes[scopeId],start,end,isExpression),inlineMenu.close()}),void inlineMenu.onClose(function(){inlineMenu.close()})):(editor.displayErrorMessageAtCursor(Strings.ERROR_EXTRACTTO_FUNCTION_NOT_VALID),void result.resolve(Strings.ERROR_EXTRACTTO_FUNCTION_NOT_VALID))}).fail(function(){editor.displayErrorMessageAtCursor(Strings.ERROR_TERN_FAILED),result.resolve(Strings.ERROR_TERN_FAILED)}),result.promise()}function initializeSession(editor){session=new Session(editor)}exports.handleExtractToFunction=handleExtractToFunction}),define("ExtractToVariable",function(require,exports,module){var ASTWalker=brackets.getModule("thirdparty/acorn/dist/walk"),EditorManager=brackets.getModule("editor/EditorManager"),Session=brackets.getModule("JSUtils/Session"),RefactoringUtils=require("RefactoringUtils"),Strings=brackets.getModule("strings"),InlineMenu=brackets.getModule("widgets/InlineMenu").InlineMenu,session=null;function extract(scopes,parentStatement,expns,text,insertPosition){var varType="var",varName=RefactoringUtils.getUniqueIdentifierName(scopes,"extracted"),varDeclaration="var "+varName+" = "+text+";\n",parentStatementStartPos=session.editor.posFromIndex(parentStatement.start),insertStartPos=insertPosition||parentStatementStartPos,selections=[],doc=session.editor.document,replaceExpnIndex=0,posToIndent,edits=[];"ExpressionStatement"===parentStatement.type&&RefactoringUtils.isEqual(parentStatement.expression,expns[0])&&insertStartPos.line===parentStatementStartPos.line&&insertStartPos.ch===parentStatementStartPos.ch&&(varDeclaration="var "+varName+" = ",replaceExpnIndex=1),posToIndent=doc.adjustPosForChange(insertStartPos,varDeclaration.split("\n"),insertStartPos,insertStartPos);for(var i=replaceExpnIndex;i<expns.length;++i)expns[i].start=session.editor.posFromIndex(expns[i].start),expns[i].end=session.editor.posFromIndex(expns[i].end),expns[i].start=doc.adjustPosForChange(expns[i].start,varDeclaration.split("\n"),insertStartPos,insertStartPos),expns[i].end=doc.adjustPosForChange(expns[i].end,varDeclaration.split("\n"),insertStartPos,insertStartPos),edits.push({edit:{text:varName,start:expns[i].start,end:expns[i].end},selection:{start:expns[i].start,end:{line:expns[i].start.line,ch:expns[i].start.ch+varName.length}}});doc.batchOperation(function(){doc.replaceRange(varDeclaration,insertStartPos),(selections=doc.doMultipleEdits(edits)).push({start:{line:insertStartPos.line,ch:insertStartPos.ch+"var".length+1},end:{line:insertStartPos.line,ch:insertStartPos.ch+"var".length+varName.length+1},primary:!0}),session.editor.setSelections(selections),session.editor._codeMirror.indentLine(posToIndent.line,"smart")})}function findAllExpressions(parentBlockStatement,expn,text){var doc=session.editor.document,obj={},expns=[];return obj[expn.type]=function(node){text===doc.getText().substr(node.start,node.end-node.start)&&expns.push(node)},ASTWalker.simple(parentBlockStatement,obj),expns}function getExpressions(ast,start,end){for(var expns=[],s=start,e=end,expn;expn=RefactoringUtils.findSurroundExpression(ast,{start:s,end:e});)expns.push(expn),s=expn.start-1;function checkExpnEquality(e){return e.start===expn.start&&e.end===expn.end}for(s=start,e=end;expn=RefactoringUtils.findSurroundExpression(ast,{start:s,end:e});)e=expn.end+1,expns.find(checkExpnEquality)||expns.push(expn);return expns}function extractToVariable(ast,start,end,text,scopes){var doc=session.editor.document,editor=EditorManager.getActiveEditor(),parentExpn=RefactoringUtils.getExpression(ast,start,end,doc.getText()),expns=[],parentBlockStatement,parentStatement;parentExpn?doc.getText().substr(parentExpn.start,parentExpn.end-parentExpn.start)===text?(parentBlockStatement=RefactoringUtils.findSurroundASTNode(ast,parentExpn,["BlockStatement","Program"]),expns=findAllExpressions(parentBlockStatement,parentExpn,text),RefactoringUtils.getScopeData(session,editor.posFromIndex(expns[0].start)).done(function(scope){var firstExpnsScopes=RefactoringUtils.getAllScopes(ast,scope,doc.getText()),insertPostion;if(parentStatement=RefactoringUtils.findSurroundASTNode(ast,expns[0],["Statement"]),scopes.length<firstExpnsScopes.length){var parentScope;parentScope=expns[0].body&&"BlockStatement"===expns[0].body.type?firstExpnsScopes[firstExpnsScopes.length-scopes.length]:firstExpnsScopes[firstExpnsScopes.length-scopes.length-1];var insertNode=RefactoringUtils.findSurroundASTNode(ast,parentScope.originNode,["Statement"]);insertNode&&(insertPostion=session.editor.posFromIndex(insertNode.start))}extract(scopes,parentStatement,expns,text,insertPostion)})):(parentStatement=RefactoringUtils.findSurroundASTNode(ast,parentExpn,["Statement"]),extract(scopes,parentStatement,[{start:start,end:end}],text)):session.editor.displayErrorMessageAtCursor(Strings.ERROR_EXTRACTTO_VARIABLE_NOT_VALID)}function handleExtractToVariable(){var editor=EditorManager.getActiveEditor();if(editor.getSelections().length>1)editor.displayErrorMessageAtCursor(Strings.ERROR_EXTRACTTO_VARIABLE_MULTICURSORS);else{initializeSession(editor);var selection=editor.getSelection(),doc=editor.document,retObj=RefactoringUtils.normalizeText(editor.getSelectedText(),editor.indexFromPos(selection.start),editor.indexFromPos(selection.end),!0),text=retObj.text,start=retObj.start,end=retObj.end,ast,scopes,expns,inlineMenu;RefactoringUtils.getScopeData(session,editor.posFromIndex(start)).done(function(scope){if(ast=RefactoringUtils.getAST(doc.getText()),scopes=RefactoringUtils.getAllScopes(ast,scope,doc.getText()),editor.hasSelection())extractToVariable(ast,start,end,text,scopes);else{if((expns=getExpressions(ast,start,end)).forEach(function(expn,index){expn.value=doc.getText().substr(expn.start,expn.end-expn.start)}),expns.sort(function(a,b){return a.value.length-b.value.length}),!expns||!expns.length)return void session.editor.displayErrorMessageAtCursor(Strings.ERROR_EXTRACTTO_VARIABLE_NOT_VALID);var firstExpnLength=RefactoringUtils.numLines(expns[0].value);if((expns=expns.filter(function(expn){return RefactoringUtils.numLines(expn.value)===firstExpnLength})).forEach(function(expn,index){RefactoringUtils.numLines(expn.value)>1?expn.name=expn.value.substr(0,expn.value.indexOf("\n"))+"...":expn.name=expn.value}),1===expns.length)return void callExtractToVariable(expns[0].start,expns[0].end,expns[0].value);expns.forEach(function(expn,index){expn.id=index}),(inlineMenu=new InlineMenu(session.editor,Strings.EXTRACTTO_VARIABLE_SELECT_EXPRESSION)).onHover(function(expnId){editor.off("scroll.inlinemenu"),editor.isLineVisible(editor.posFromIndex(expns[expnId].end).line)||editor.on("scroll.inlinemenu",function(){editor.off("scroll.inlinemenu"),inlineMenu.openRemovedMenu()}),editor.setSelection(editor.posFromIndex(expns[expnId].start),editor.posFromIndex(expns[expnId].end))}),inlineMenu.open(expns),inlineMenu.onSelect(function(expnId){callExtractToVariable(expns[expnId].start,expns[expnId].end,expns[expnId].value),inlineMenu.close()}),inlineMenu.onClose(function(){inlineMenu.close()})}}).fail(function(){editor.displayErrorMessageAtCursor(Strings.ERROR_TERN_FAILED)})}function callExtractToVariable(startPos,endPos,value){RefactoringUtils.getScopeData(session,editor.posFromIndex(startPos)).done(function(expnscope){scopes=RefactoringUtils.getAllScopes(ast,expnscope,doc.getText()),extractToVariable(ast,startPos,endPos,value,scopes)}).fail(function(){editor.displayErrorMessageAtCursor(Strings.ERROR_TERN_FAILED)})}}function initializeSession(editor){session=new Session(editor)}exports.handleExtractToVariable=handleExtractToVariable}),define("HighLightReferences",function(require,exports,module){let EditorManager=brackets.getModule("editor/EditorManager"),ScopeManager=brackets.getModule("JSUtils/ScopeManager"),Session=brackets.getModule("JSUtils/Session"),MessageIds=JSON.parse(brackets.getModule("text!JSUtils/MessageIds.json")),Editor=brackets.getModule("editor/Editor").Editor,session=null;function initializeSession(editor){session=new Session(editor)}function getRefs(fileInfo,offset){return ScopeManager.postMessage({type:MessageIds.TERN_REFS,fileInfo:fileInfo,offset:offset}),ScopeManager.addPendingRequest(fileInfo.name,offset,MessageIds.TERN_REFS)}function requestFindRefs(session,document,offset){if(!document||!session)return;let path=document.file.fullPath,fileInfo,ternPromise;return{promise:getRefs({type:MessageIds.TERN_FILE_INFO_TYPE_FULL,name:path,offsetLines:0,text:ScopeManager.filterText(session.getJavascriptText())},offset)}}const HIGHLIGHT_REFS_MARKER="JS_REFS";function _handleHighLightRefs(editor,refsResp){refsResp&&refsResp.references&&refsResp.references.refs&&editor.operation(function(){for(let ref of refsResp.references.refs)editor.document.file.fullPath.endsWith(ref.file)&&editor.markText(HIGHLIGHT_REFS_MARKER,ref.start,ref.end,Editor.getMarkOptionMatchingRefs())})}function _hasASingleCursor(editor){let selections=editor.getSelections();if(selections.length>1)return!1;let start=selections[0].start,end=selections[0].end;return start.line===end.line&&start.ch===end.ch}let allowedHighlightTypes=["def","variable","variable-2","variable-3","property"],lastHighlightToken={};function _cursorActivity(_evt,editor){if("javascript"!==editor.getModeForSelection())return;if(!_hasASingleCursor(editor))return void editor.clearAllMarks(HIGHLIGHT_REFS_MARKER);let token=editor.getToken();if(lastHighlightToken===token)return;if(editor.clearAllMarks(HIGHLIGHT_REFS_MARKER),lastHighlightToken=token,!allowedHighlightTypes.includes(token.type))return;let offset=session.getOffset();requestFindRefs(session,session.editor.document,offset).promise.done(response=>{_handleHighLightRefs(editor,response)}).fail(function(err){console.error("find references failed with: ",err)})}function _activeEditorChanged(_evt,current,previous){previous&&previous.off("cursorActivity.highlightRefs"),current&&(current.off("cursorActivity.highlightRefs"),current.on("cursorActivity.highlightRefs",_cursorActivity),initializeSession(current),_cursorActivity(_evt,current))}EditorManager.on("activeEditorChange",_activeEditorChanged),exports.HIGHLIGHT_REFS_MARKER=HIGHLIGHT_REFS_MARKER}),define("RefactoringUtils",function(require,exports,module){var Acorn=brackets.getModule("thirdparty/acorn/dist/acorn"),ASTWalker=brackets.getModule("thirdparty/acorn/dist/walk"),MessageIds=JSON.parse(brackets.getModule("text!JSUtils/MessageIds.json")),_=brackets.getModule("thirdparty/lodash"),AcornLoose=brackets.getModule("thirdparty/acorn/dist/acorn_loose"),ScopeManager=brackets.getModule("JSUtils/ScopeManager"),templates=JSON.parse(require("text!Templates.json")),FUNCTION_BODY_PREFIX_LENGTH=30;function isEqual(a,b){return a.start===b.start&&a.end===b.end}function getExpression(ast,start,end,fileText){var expn=findSurroundExpression(ast,{start:start,end:end});if(!expn)return!1;if("ClassExpression"===expn.type&&expn.start===start&&expn.end-end<=1)return expn.end=end,expn;if(expn.start===start&&expn.end===end)return expn;if(!["BinaryExpression","LogicalExpression","SequenceExpression"].includes(expn.type))return!1;var parentExpn=expn,parentExpStr=fileText.substr(parentExpn.start,parentExpn.end-parentExpn.start),str,node=isStandAloneExpression(parentExpStr.substr(0,start-parentExpn.start)+"placeHolder"+parentExpStr.substr(end-parentExpn.start));return!(!node||node.type!==parentExpn.type)&&parentExpn}function getAST(text){var ast;try{ast=Acorn.parse(text,{ecmaVersion:9})}catch(e){ast=AcornLoose.parse(text,{ecmaVersion:9})}return ast}function checkStatement(ast,start,end,fileText){var notStatement=!1;if(ASTWalker.simple(getAST(fileText.substr(start,end-start)),{FunctionDeclaration:function(node){notStatement=!0},ClassDeclaration:function(node){notStatement=!0}}),notStatement)return!1;var startStatement=findSurroundASTNode(ast,{start:start},["Statement"]),endStatement=findSurroundASTNode(ast,{start:end},["Statement"]);return startStatement&&endStatement&&startStatement.start===start&&startStatement.end<=end&&endStatement.start>=start&&endStatement.end===end}function getUniqueIdentifierName(scopes,prefix,num){if(!scopes)return prefix;var props=scopes.reduce(function(props,scope){return _.union(props,_.keys(scope.props))},[]),name;if(!props)return prefix;for(num=num||"1";num<100&&(name=prefix+num,-1!==props.indexOf(name));)++num;return name}function numLines(text){return text.split("\n").length}function isStandAloneExpression(text){var found=ASTWalker.findNodeAt(getAST(text),0,text.length,function(nodeType,node){return"Expression"===nodeType});return found&&found.node}function getScopeData(session,offset){var path=session.path,fileInfo={type:MessageIds.TERN_FILE_INFO_TYPE_FULL,name:path,offsetLines:0,text:ScopeManager.filterText(session.getJavascriptText())};ScopeManager.postMessage({type:MessageIds.TERN_SCOPEDATA_MSG,fileInfo:fileInfo,offset:offset});var ternPromise=ScopeManager.addPendingRequest(fileInfo.name,offset,MessageIds.TERN_SCOPEDATA_MSG),result=new $.Deferred;return ternPromise.done(function(response){result.resolveWith(null,[response.scope])}).fail(function(){result.reject()}),result}function normalizeText(text,start,end,removeTrailingSemiColons){var trimmedText;return(trimmedText=_.trimLeft(text)).length<text.length&&(start+=text.length-trimmedText.length),text=trimmedText,(trimmedText=_.trimRight(text)).length<text.length&&(end-=text.length-trimmedText.length),text=trimmedText,removeTrailingSemiColons&&(trimmedText=_.trimRight(text,";")).length<text.length&&(end-=text.length-trimmedText.length),{text:trimmedText,start:start,end:end}}function isFnScope(scope){return!scope.isBlock&&!scope.isCatch}function findSurroundExpression(ast,expn){for(var start=expn.start,end=expn.end,surroundExpn;;){if(!(surroundExpn=findSurroundASTNode(ast,{start:start,end:end},["Expression"])))return null;if("SequenceExpression"===surroundExpn.type)start=surroundExpn.start-1;else{if("FunctionExpression"!==surroundExpn.type)return surroundExpn;var methodDefinitionNode=findSurroundASTNode(ast,surroundExpn,["MethodDefinition"]);if(!methodDefinitionNode||!isEqual(methodDefinitionNode.value,surroundExpn))return surroundExpn;start=surroundExpn.start-1}}return surroundExpn}function findSurroundASTNode(ast,expn,types){var foundNode=ASTWalker.findNodeAround(ast,expn.start,function(nodeType,node){return expn.end?types.includes(nodeType)&&node.end>=expn.end:types.includes(nodeType)});return foundNode&&_.clone(foundNode.node)}function getAllScopes(ast,scope,fullText){for(var curScope=scope,cnt=0,scopes=[];curScope;){if(curScope.id=cnt++,scopes.push(curScope),curScope.fnType)if("FunctionExpression"===curScope.fnType){var methodDefinitionNode=findSurroundASTNode(ast,curScope.originNode,["MethodDefinition"]);if(methodDefinitionNode&&isEqual(methodDefinitionNode.value,curScope.originNode)){curScope.name=methodDefinitionNode.key.name,curScope.originNode=methodDefinitionNode;var classNode=findSurroundASTNode(ast,methodDefinitionNode,["ClassDeclaration","ClassExpression"]);if(classNode){var temp=curScope.prev,newScope={isClass:!0};if("ClassExpression"===classNode.type){var assignmentExpNode=findSurroundASTNode(ast,classNode,["AssignmentExpression"]);if(assignmentExpNode&&assignmentExpNode.left&&assignmentExpNode.left.name)newScope.name="class "+assignmentExpNode.left.name;else{var varDeclaratorNode=findSurroundASTNode(ast,classNode,["VariableDeclarator"]);varDeclaratorNode&&varDeclaratorNode.id&&varDeclaratorNode.id.name?newScope.name="class "+varDeclaratorNode.id.name:newScope.name="class null"}}else newScope.name="class "+(classNode.id&&classNode.id.name);newScope.originNode=classNode,curScope.prev=newScope,newScope.prev=temp}}else curScope.name="function starting with "+fullText.substr(curScope.originNode.body.start,Math.min(FUNCTION_BODY_PREFIX_LENGTH,curScope.originNode.body.end-curScope.originNode.body.start))}else"✖"===curScope.fnType?curScope.name="function starting with "+fullText.substr(curScope.originNode.body.start,Math.min(FUNCTION_BODY_PREFIX_LENGTH,curScope.originNode.body.end-curScope.originNode.body.start)):curScope.name=curScope.fnType;else curScope.originNode||(curScope.name="global");curScope=curScope.prev}return scopes}function RefactoringSession(editor){this.editor=editor,this.document=editor.document,this.selection=editor.getSelection(),this.text=this.document.getText(),this.selectedText=editor.getSelectedText(),this.cm=editor._codeMirror,this.startIndex=editor.indexFromPos(this.selection.start),this.endIndex=editor.indexFromPos(this.selection.end),this.startPos=this.selection.start,this.endPos=this.selection.end,this.ast=this.createAstOfCurrentDoc()}RefactoringSession.prototype.lineEndPosition=function(line){var lineText;return{line:line,ch:this.document.getLine(line).length}},RefactoringSession.prototype.createAstOfCurrentDoc=function(){var ast,text=this.document.getText();try{ast=Acorn.parse(text)}catch(e){ast=AcornLoose.parse(text)}return ast},RefactoringSession.prototype.replaceTextFromTemplate=function(template,args,rangeToReplace,subTemplate){var templateText=templates[template];subTemplate&&(templateText=templateText[subTemplate]);var compiled,formattedText=_.template(templateText)(args);rangeToReplace||(rangeToReplace=this.editor.getSelection()),this.document.replaceRange(formattedText,rangeToReplace.start,rangeToReplace.end);for(var startLine=rangeToReplace.start.line,endLine=startLine+formattedText.split("\n").length,i=startLine+1;i<endLine;i++)this.cm.indentLine(i)},RefactoringSession.prototype.getParamsOfFunction=function getParamsOfFunction(start,end,selectedText){var param=[];return ASTWalker.simple(AcornLoose.parse(selectedText),{Function:function(node){"FunctionDeclaration"===node.type&&node.params.forEach(function(item){param.push(item.name)})}}),param},RefactoringSession.prototype.getParentNode=function(ast,start){var foundNode=ASTWalker.findNodeAround(ast,start,function(nodeType,node){return"ObjectExpression"===nodeType});return foundNode&&foundNode.node},RefactoringSession.prototype.isLastNodeInScope=function(ast,start){var parentNode=this.getParentNode(ast,start),currentNodeStart;return ASTWalker.simple(parentNode,{Property:function(node){currentNodeStart=node.start}}),start>=currentNodeStart},exports.isEqual=isEqual,exports.getUniqueIdentifierName=getUniqueIdentifierName,exports.isStandAloneExpression=isStandAloneExpression,exports.numLines=numLines,exports.getScopeData=getScopeData,exports.normalizeText=normalizeText,exports.getExpression=getExpression,exports.isFnScope=isFnScope,exports.getAllScopes=getAllScopes,exports.checkStatement=checkStatement,exports.findSurroundASTNode=findSurroundASTNode,exports.getAST=getAST,exports.findSurroundExpression=findSurroundExpression,exports.RefactoringSession=RefactoringSession}),define("RenameIdentifier",function(require,exports,module){const EditorManager=brackets.getModule("editor/EditorManager"),ScopeManager=brackets.getModule("JSUtils/ScopeManager"),Session=brackets.getModule("JSUtils/Session"),MessageIds=JSON.parse(brackets.getModule("text!JSUtils/MessageIds.json")),TokenUtils=brackets.getModule("utils/TokenUtils"),Strings=brackets.getModule("strings"),Keys=brackets.getModule("command/Keys"),Editor=brackets.getModule("editor/Editor").Editor,ProjectManager=brackets.getModule("project/ProjectManager");let session=null,keywords=["define","alert","exports","require","module","arguments"];const MARK_TYPE_RENAME="renameVar";function initializeSession(editor){session=new Session(editor)}function getRefs(fileInfo,offset){return ScopeManager.postMessage({type:MessageIds.TERN_REFS,fileInfo:fileInfo,offset:offset}),ScopeManager.addPendingRequest(fileInfo.name,offset,MessageIds.TERN_REFS)}function requestFindRefs(session,document,offset){if(!document||!session)return;let path=document.file.fullPath,fileInfo,ternPromise;return{promise:getRefs({type:MessageIds.TERN_FILE_INFO_TYPE_FULL,name:path,offsetLines:0,text:ScopeManager.filterText(session.getJavascriptText())},offset)}}function handleRename(){let editor=EditorManager.getActiveEditor(),offset,token;if(!editor)return;if(editor.getSelections().length>1)return void editor.displayErrorMessageAtCursor(Strings.ERROR_RENAME_MULTICURSOR);if(initializeSession(editor),!editor||"javascript"!==editor.getModeForSelection())return;if(token=TokenUtils.getTokenAt(editor._codeMirror,editor._codeMirror.posFromIndex(session.getOffset())),keywords.indexOf(token.string)>=0)return void editor.displayErrorMessageAtCursor(Strings.ERROR_RENAME_GENERAL);let result=new $.Deferred;function isInSameFile(obj,refsResp){let projectRoot=ProjectManager.getProjectRoot(),projectDir,fileName="";return projectRoot&&(projectDir=projectRoot.fullPath),projectDir&&refsResp&&refsResp.file&&0===refsResp.file.indexOf(projectDir)&&(fileName=refsResp.file.slice(projectDir.length)),obj&&(obj.file===refsResp.file||obj.file===fileName||obj.file===refsResp.file.slice(1,refsResp.file.length))}function _multiFileRename(refs){}function _isCursorWithinMark(cursorPos,marker){if(!marker)return!1;var pos=marker.find();if(!pos)return!1;var from=pos.from,to=pos.to;return!(cursorPos.line<from.line||cursorPos.line>to.line)&&(!(cursorPos.line===from.line&&cursorPos.ch<from.ch)&&!(cursorPos.line===to.line&&cursorPos.ch>to.ch))}function _outlineText(currentEditor){let selections;if(currentEditor.getSelections().length>1){let primary=currentEditor.getSelection();currentEditor.markText(MARK_TYPE_RENAME,primary.start,primary.end,Editor.getMarkOptionRenameOutline()),currentEditor.off(Editor.EVENT_BEFORE_SELECTION_CHANGE+".renameVar"),currentEditor.off(Editor.EVENT_CURSOR_ACTIVITY+".renameVar"),currentEditor.off(Editor.EVENT_KEY_DOWN+".renameVar"),currentEditor.on(Editor.EVENT_BEFORE_SELECTION_CHANGE+".renameVar",function(_evt,newSelections){newSelections.ranges&&1===newSelections.ranges.length&&(currentEditor.clearAllMarks(MARK_TYPE_RENAME),currentEditor.off(Editor.EVENT_BEFORE_SELECTION_CHANGE+".renameVar"))}),currentEditor.on(Editor.EVENT_CURSOR_ACTIVITY+".renameVar",function(_evt,newSelections){const mainCursor=currentEditor.getCursorPos();let primaryMark=currentEditor.getAllMarks(MARK_TYPE_RENAME);(primaryMark=primaryMark&&primaryMark[0])&&!_isCursorWithinMark(mainCursor,primaryMark)&&(currentEditor.clearAllMarks(MARK_TYPE_RENAME),currentEditor.off(Editor.EVENT_BEFORE_SELECTION_CHANGE+".renameVar"),currentEditor.setCursorPos(mainCursor.line,mainCursor.ch))}),currentEditor.on(Editor.EVENT_KEY_DOWN+".renameVar",function(_evt,_editor,keyboardEvent){const mainCursor=currentEditor.getCursorPos();let primaryMark=currentEditor.getAllMarks(MARK_TYPE_RENAME);!(primaryMark=primaryMark&&primaryMark[0])||keyboardEvent.key!==Keys.KEY.RETURN&&keyboardEvent.key!==Keys.KEY.ENTER||(currentEditor.clearAllMarks(MARK_TYPE_RENAME),currentEditor.off(Editor.EVENT_KEY_DOWN+".renameVar"),currentEditor.setCursorPos(mainCursor.line,mainCursor.ch),keyboardEvent.preventDefault(),keyboardEvent.stopPropagation())})}}function handleFindRefs(refsResp){if(!refsResp||!refsResp.references||!refsResp.references.refs)return;let inlineWidget=EditorManager.getFocusedInlineWidget(),editor=EditorManager.getActiveEditor(),refs=refsResp.references.refs;if(inlineWidget){let isInTextRange;if(!!refs.find(function(item){return item.start.line<inlineWidget._startLine||item.end.line>inlineWidget._endLine}))return void editor.displayErrorMessageAtCursor(Strings.ERROR_RENAME_QUICKEDIT)}let currentPosition=editor.posFromIndex(refsResp.offset),refsArray,primaryRef;(refsArray=refs.filter(function(element){return isInSameFile(element,refsResp)})).length===refs.length&&(refsArray.find(function(element){return(element.start.line===currentPosition.line||element.end.line===currentPosition.line)&&currentPosition.ch<=element.end.ch&&currentPosition.ch>=element.start.ch}).primary=!0,editor.setSelections(refsArray),_outlineText(editor))}function requestFindReferences(session,offset){let response=requestFindRefs(session,session.editor.document,offset);response&&response.hasOwnProperty("promise")&&response.promise.done(handleFindRefs).fail(function(errorMsg){EditorManager.getActiveEditor().displayErrorMessageAtCursor(errorMsg),result.reject()})}return offset=session.getOffset(),requestFindReferences(session,offset),result.promise()}exports._MARK_TYPE_RENAME=MARK_TYPE_RENAME,exports.handleRename=handleRename}),define("WrapSelection",function(require,exports,module){var _=brackets.getModule("thirdparty/lodash"),EditorManager=brackets.getModule("editor/EditorManager"),TokenUtils=brackets.getModule("utils/TokenUtils"),Strings=brackets.getModule("strings"),RefactoringUtils=require("RefactoringUtils"),RefactoringSession=RefactoringUtils.RefactoringSession,WRAP_IN_CONDITION="wrapCondition",ARROW_FUNCTION="arrowFunction",GETTERS_SETTERS="gettersSetters",TRY_CATCH="tryCatch",current=null;function initializeRefactoringSession(editor){current=new RefactoringSession(editor)}function _wrapSelectedStatements(wrapperName,err){var editor=EditorManager.getActiveEditor();if(editor){initializeRefactoringSession(editor);var startIndex=current.startIndex,endIndex=current.endIndex,selectedText=current.selectedText,pos;if(0===selectedText.length){var statementNode=RefactoringUtils.findSurroundASTNode(current.ast,{start:startIndex},["Statement"]);if(!statementNode)return void current.editor.displayErrorMessageAtCursor(err);selectedText=current.text.substr(statementNode.start,statementNode.end-statementNode.start),startIndex=statementNode.start,endIndex=statementNode.end}else{var selectionDetails=RefactoringUtils.normalizeText(selectedText,startIndex,endIndex);selectedText=selectionDetails.text,startIndex=selectionDetails.start,endIndex=selectionDetails.end}if(RefactoringUtils.checkStatement(current.ast,startIndex,endIndex,selectedText))if(pos={start:current.cm.posFromIndex(startIndex),end:current.cm.posFromIndex(endIndex)},current.document.batchOperation(function(){current.replaceTextFromTemplate(wrapperName,{body:selectedText},pos)}),wrapperName===TRY_CATCH){var cursorLine=current.editor.getSelection().end.line-1,startCursorCh=current.document.getLine(cursorLine).indexOf("//"),endCursorCh=current.document.getLine(cursorLine).length;current.editor.setSelection({line:cursorLine,ch:startCursorCh},{line:cursorLine,ch:endCursorCh})}else wrapperName===WRAP_IN_CONDITION&&current.editor.setSelection({line:pos.start.line,ch:pos.start.ch+4},{line:pos.start.line,ch:pos.start.ch+13});else current.editor.displayErrorMessageAtCursor(err)}}function wrapInTryCatch(){_wrapSelectedStatements(TRY_CATCH,Strings.ERROR_TRY_CATCH)}function wrapInCondition(){_wrapSelectedStatements(WRAP_IN_CONDITION,Strings.ERROR_WRAP_IN_CONDITION)}function convertToArrowFunction(){var editor=EditorManager.getActiveEditor();if(editor){initializeRefactoringSession(editor);var funcExprNode=RefactoringUtils.findSurroundASTNode(current.ast,{start:current.startIndex},["Function"]);if(funcExprNode&&"FunctionExpression"===funcExprNode.type&&!funcExprNode.id)if("FunctionDeclaration"!==funcExprNode){if(funcExprNode.body){var noOfStatements=funcExprNode.body.body.length,selectedText=current.text.substr(funcExprNode.start,funcExprNode.end-funcExprNode.start),param=[],dontChangeParam=!1,numberOfParams=funcExprNode.params.length,treatAsManyParam=!1;funcExprNode.params.forEach(function(item){"Identifier"===item.type?param.push(item.name):"AssignmentPattern"===item.type&&(dontChangeParam=!0)}),dontChangeParam&&(numberOfParams>=1&&(param.splice(0,param.length),param.push(current.text.substr(funcExprNode.params[0].start,funcExprNode.params[numberOfParams-1].end-funcExprNode.params[0].start)),1===numberOfParams&&(treatAsManyParam=!0)),dontChangeParam=!1);var loc={fullFunctionScope:{start:funcExprNode.start,end:funcExprNode.end},functionsDeclOnly:{start:funcExprNode.start,end:funcExprNode.body.start}},locPos={fullFunctionScope:{start:current.cm.posFromIndex(loc.fullFunctionScope.start),end:current.cm.posFromIndex(loc.fullFunctionScope.end)},functionsDeclOnly:{start:current.cm.posFromIndex(loc.functionsDeclOnly.start),end:current.cm.posFromIndex(loc.functionsDeclOnly.end)}},isReturnStatement=noOfStatements>=1&&"ReturnStatement"===funcExprNode.body.body[0].type,bodyStatements=funcExprNode.body.body[0],params;bodyStatements||(bodyStatements=funcExprNode.body),params={params:param.join(", "),statement:_.trimRight(current.text.substr(bodyStatements.start,bodyStatements.end-bodyStatements.start),";")},isReturnStatement&&(params.statement=params.statement.substr(7).trim()),1===noOfStatements?current.document.batchOperation(function(){1!==numberOfParams||treatAsManyParam?current.replaceTextFromTemplate(ARROW_FUNCTION,params,locPos.fullFunctionScope,"manyParamOneStament"):current.replaceTextFromTemplate(ARROW_FUNCTION,params,locPos.fullFunctionScope,"oneParamOneStament")}):current.document.batchOperation(function(){1!==numberOfParams||treatAsManyParam?current.replaceTextFromTemplate(ARROW_FUNCTION,{params:param.join(", ")},locPos.functionsDeclOnly,"manyParamManyStament"):current.replaceTextFromTemplate(ARROW_FUNCTION,{params:param},locPos.functionsDeclOnly,"oneParamManyStament")}),current.editor.setCursorPos(locPos.functionsDeclOnly.end.line,locPos.functionsDeclOnly.end.ch,!1)}}else current.editor.displayErrorMessageAtCursor(Strings.ERROR_ARROW_FUNCTION);else current.editor.displayErrorMessageAtCursor(Strings.ERROR_ARROW_FUNCTION)}}function createGettersAndSetters(){var editor=EditorManager.getActiveEditor();if(editor){initializeRefactoringSession(editor);var startIndex=current.startIndex,endIndex=current.endIndex,selectedText=current.selectedText;if(selectedText.length>=1){var selectionDetails=RefactoringUtils.normalizeText(selectedText,startIndex,endIndex);selectedText=selectionDetails.text,startIndex=selectionDetails.start,endIndex=selectionDetails.end}var token=TokenUtils.getTokenAt(current.cm,current.cm.posFromIndex(endIndex)),commaString=",",isLastNode,templateParams,parentNode,propertyEndPos;if("property"===token.type)if((parentNode=current.getParentNode(current.ast,endIndex))&&parentNode.properties){var propertyNodeArray=parentNode.properties,properyNodeIndex=propertyNodeArray.findIndex(function(element){return endIndex>=element.start&&endIndex<element.end}),propertyNode=propertyNodeArray[properyNodeIndex],nextPropertNode,nextPropertyStartPos,getSetPos;propertyEndPos=editor.posFromIndex(propertyNode.end),!(isLastNode=current.isLastNodeInScope(current.ast,endIndex))&&properyNodeIndex+1<=propertyNodeArray.length-1&&(nextPropertNode=propertyNodeArray[properyNodeIndex+1],nextPropertyStartPos=editor.posFromIndex(nextPropertNode.start),propertyEndPos.line!==nextPropertyStartPos.line?propertyEndPos=current.lineEndPosition(current.startPos.line):(propertyEndPos=nextPropertyStartPos,commaString=", ")),getSetPos=isLastNode?current.document.adjustPosForChange(propertyEndPos,commaString.split("\n"),propertyEndPos,propertyEndPos):propertyEndPos,templateParams={getName:token.string,setName:token.string,tokenName:token.string},current.document.batchOperation(function(){isLastNode&&current.document.replaceRange(commaString,propertyEndPos,propertyEndPos),current.editor.setSelection(getSetPos),current.replaceTextFromTemplate(GETTERS_SETTERS,templateParams),isLastNode||current.document.replaceRange(commaString,current.editor.getSelection().start,current.editor.getSelection().start)})}else current.editor.displayErrorMessageAtCursor(Strings.ERROR_GETTERS_SETTERS);else current.editor.displayErrorMessageAtCursor(Strings.ERROR_GETTERS_SETTERS)}}exports.wrapInCondition=wrapInCondition,exports.wrapInTryCatch=wrapInTryCatch,exports.convertToArrowFunction=convertToArrowFunction,exports.createGettersAndSetters=createGettersAndSetters});
//# sourceMappingURL=extension-min.js.map
